<html>
<head>
<!-- Load the Paper.js library -->
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js" integrity="sha512-ovjLI1ZcZe6bw+ImQ21r+sv8q/Vwob2kq7tFidK6E1LWfi0T4uobbmpfEU1//a9h9o5Kkt+MnMWf6rWlg0EiMw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!--<script integrity="" src="js/mindmup-editabletable.js" integrity="sha512-ovjLI1ZcZe6bw+ImQ21r+sv8q/Vwob2kq7tFidK6E1LWfi0T4uobbmpfEU1//a9h9o5Kkt+MnMWf6rWlg0EiMw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>-->
<style>
body { 
        font-family: Verdana,Geneva,sans-serif; 
    }    
</style>
<script type="text/javascript">

function loadTableWidget(){
    $.fn.editableTableWidget=function(e){"use strict";return $(this).each(function(){var t,i,n=$.extend(((i=$.extend({},$.fn.editableTableWidget.defaultOptions)).editor=i.editor.clone(),i),e),o=$(this),r=n.editor.css("position","absolute").hide().appendTo(o.parent()),s=function(e){(t=o.find("td:focus")).length&&(r.val(t.text()).removeClass("error").show().offset(t.offset()).css(t.css(n.cloneProperties)).width(t.width()).height(t.height()).focus(),e&&r.select())},d=function(){var e,i=r.val(),n=$.Event("change");if(t.text()===i||r.hasClass("error"))return!0;e=t.html(),t.text(i).trigger(n,i),!1===n.result&&t.html(e)},a=function(e,t){return 39===t?e.next("td"):37===t?e.prev("td"):38===t?e.parent().prev().children().eq(e.index()):40===t?e.parent().next().children().eq(e.index()):[]};r.blur(function(){d(),r.hide()}).keydown(function(e){if(13===e.which)d(),r.hide(),t.focus(),e.preventDefault(),e.stopPropagation();else if(27===e.which)r.val(t.text()),e.preventDefault(),e.stopPropagation(),r.hide(),t.focus();else if(9===e.which)t.focus();else if(this.selectionEnd-this.selectionStart===this.value.length){var i=a(t,e.which);i.length>0&&(i.focus(),e.preventDefault(),e.stopPropagation())}}).on("input paste",function(){var e=$.Event("validate");t.trigger(e,r.val()),!1===e.result?r.addClass("error"):r.removeClass("error")}),o.on("click keypress dblclick",s).css("cursor","pointer").keydown(function(e){var t=!0,i=a($(e.target),e.which);i.length>0?i.focus():13===e.which?s(!1):17===e.which||91===e.which||93===e.which?(s(!0),t=!1):t=!1,t&&(e.stopPropagation(),e.preventDefault())}),o.find("td").prop("tabindex",1),$(window).on("resize",function(){r.is(":visible")&&r.offset(t.offset()).width(t.width()).height(t.height())})})},$.fn.editableTableWidget.defaultOptions={cloneProperties:["padding","padding-top","padding-bottom","padding-left","padding-right","text-align","font","font-size","font-family","font-weight","border","border-top","border-bottom","border-left","border-right"],editor:$("<input>")};
}

shape=[
    [0, 32],  
    [600, 32],  
    [700, 50],  
    [800, 40],  
    [1150, 40],  
    [1250, 60],  
    [1350, 42],  
    [1700, 45],  
    [1800, 65],  
    [1900, 70], 
    [2000, 75]
];
DidgeShape={

    drag_index: null,
    drag_startpoint: null,
    margin: 10,
    measure_height: 50,

    select_rect: null,
    select_rect_startpoint: null,

    drag_handles: [],

    dragMode: null,
    DRAG_MODE_NONE: null,
    DRAG_MODE_MULTIPLE_SELECTING: 1,
    DRAG_MODE_MULTIPLE_SELECTED: 2,
    DRAG_MODE_MULTIPLE_DRAGGING: 3,

    shapeBeforeDrag: [],

    draw_didge: function(){

        loadTableWidget();
        var canvas = document.getElementById('myCanvas');
        paper.setup(canvas);

        paper.project.clear();
    
        maxx=0;
        maxy=0;
        for( var i=0; i<shape.length; i++){
            if( shape[i][0] > maxx ) maxx=shape[i][0];
            if( shape[i][1] > maxy ) maxy=shape[i][1];
        }
        
        canvas_width=1000;
        canvas_height=200;
        DidgeShape.scaling=canvas_width/maxx;
        center_y=canvas_height/2;

        // draw measure
        measure = new paper.Path();
        measure.strokeColor = 'black';
        measure_starty=20;
        measure.add(new paper.Point(DidgeShape.margin, measure_starty));
        measure.add(new paper.Point(DidgeShape.margin + maxx*DidgeShape.scaling, measure_starty));
        measure_ticksize=500;
        tick=0;
        ticks=[];
        while( tick<maxx ){
            ticks.push(tick);
            tick += measure_ticksize;
        }
        if(ticks[ticks-length-1] != maxx) ticks.push(Math.round(maxx));

        // draw measure ticks
        for( var i=0; i<ticks.length; i++){

            tick=ticks[i];
            tickpath=new paper.Path();
            tickpath.strokeColor="black";
            tickx=DidgeShape.margin + tick*DidgeShape.scaling
            tickpath.add(new paper.Point(tickx, measure_starty));
            tickpath.add(new paper.Point(tickx, measure_starty+5));

            text = new paper.PointText(new paper.Point(tickx, measure_starty-5));
            text.justification = 'center';
            text.fillColor = 'black';
            text.content = tick;
        }

        path_unten = new paper.Path();
        path_oben = new paper.Path();
        path_oben.strokeColor = 'black';
        path_unten.strokeColor = 'black';

        dragger_radius=5;
        $("#dimensions tbody").html("");

        selected={}
        for( var i=0; i<DidgeShape.drag_handles.length; i++){
            if( DidgeShape.drag_handles[i].selected == true){
                selected[i]=true;
            }
        }
        DidgeShape.drag_handles=[]
        for( var i=0; i<shape.length; i++){
            y_unten=DidgeShape.measure_height + DidgeShape.margin + (center_y + shape[i][1]/2)*DidgeShape.scaling;
            y_oben=DidgeShape.measure_height + DidgeShape.margin + (center_y - shape[i][1]/2) * DidgeShape.scaling;
            x=DidgeShape.margin + shape[i][0] * DidgeShape.scaling;
    
            // draw drag handles
            drag_x=paper.Shape.Rectangle(
                new paper.Point(x-2, y_unten+5),
                new paper.Point(x+2, y_oben-5)
            );
            drag_x.shapeIndex=i;
            drag_x.fillColor="white";
    
            drag_x.onMouseEnter = function(event) {
                this.fillColor = '#666666';
            };
            drag_x.onMouseLeave = function(event) {
                this.fillColor = 'white';
            };
            //drag_x.onMouseDown = function(event) {
            //    DidgeShape.drag_index=this.shapeIndex;
            //    //console.log(event);
            //    DidgeShape.drag_startpoint=event.point;
            //};

            vertical_path=new paper.Path();
            vertical_path.strokeColor="#cccccc";
            vertical_path.add(new paper.Point(x, y_unten));
            vertical_path.add(new paper.Point(x, y_oben));
            vertical_path.selected=false;

            if( i in selected ){
                vertical_path.selected=true;
                vertical_path.strokeColor="black";
            }
            DidgeShape.drag_handles.push(vertical_path);

            path_unten.add(new paper.Point(x,y_unten));
            path_oben.add(new paper.Point(x,y_oben));
    
    
            tr = $("<tr>").appendTo($("#dimensions tbody"));
                $("<td>").html(shape[i][0]).appendTo(tr);
                $("<td>").html(shape[i][1]).appendTo(tr);
        }

        
        $('#dimensions').editableTableWidget();
/*        $('#dimensions').on('validate', function(evt, newValue) {
            return !isNaN(parseInt(newValue)) && parseInt(newValue) == parseFloat(newValue) && parseInt(newValue)>=0;
        });
        $("#dimensions").on('change', function(evt, newValue) {
            shape=[];
            x=-1;
            $("#dimensions tbody td").each(function(){
                if(x==-1){
                    x=parseInt($(this).html());
                } else{
                    y=parseInt($(this).html());
                    shape.push([x,y]);
                    x=-1;
                }
            });
            DidgeShape.draw_didge();
        });
*/
        paper.view.draw();
    },

    setup: function(){
        var canvas = document.getElementById('myCanvas');
        paper.setup(canvas);
        $('#dimensions').editableTableWidget();

        canvas.addEventListener('mousedown', e => {

            if( DidgeShape.dragMode == DidgeShape.DRAG_MODE_NONE ){
                rect=new paper.Rectangle(
                    new paper.Point(e.offsetX, e.offsetY),
                    new paper.Point(e.offsetX, e.offsetY)
                );
                DidgeShape.select_rect = new paper.Path.Rectangle(rect);
                DidgeShape.select_rect.strokeColor="black";
                DidgeShape.select_rect_startpoint=new paper.Point(e.offsetX, e.offsetY);
                DidgeShape.dragMode = DidgeShape.DRAG_MODE_MULTIPLE_SELECTING;
            } else if( DidgeShape.dragMode == DidgeShape.DRAG_MODE_MULTIPLE_SELECTED){
                DidgeShape.dragMode = DidgeShape.DRAG_MODE_MULTIPLE_DRAGGING;
                DidgeShape.drag_startpoint=new paper.Point(e.offsetX, e.offsetY);
                DidgeShape.shapeBeforeDrag=[]
                for( var i=0; i<shape.length; i++){
                    DidgeShape.shapeBeforeDrag.push([shape[i][0], shape[i][1]]);
                }
            }

        });

        canvas.addEventListener('mousemove', e => {
            // move the segments
            if( DidgeShape.dragMode == DidgeShape.DRAG_MODE_MULTIPLE_DRAGGING){

                for( var i=0; i<shape.length; i++){
                    if( DidgeShape.drag_handles[i].selected ==false){
                        continue;
                    }
                    // in x direction
                    if(i>0){
                        shift = (DidgeShape.drag_startpoint.x - e.offsetX)/DidgeShape.scaling;
                        newx=shape[i][0]-shift;
                        if(newx>shape[i-1][0]+10 && (
                            DidgeShape.draw_index==shape.length-1 ||
                            newx<shape[i+1][0]-10
                        )){
                            shape[i][0] = DidgeShape.shapeBeforeDrag[i][0] - shift;
                        }
                        shape[i][0]=Math.round(shape[i][0])
                    }
                    // in y direction
                    //shifty=(DidgeShape.drag_startpoint.y - e.offsetY)/DidgeShape.scaling;
                    //shape[i][1] += shifty;
                    //shape[i][1]=Math.round(shape[i][1])
                    //if(shape[i][1] < 1) shape[i][1]=1;
                }

    
                DidgeShape.draw_didge();
            }

            // do not rectangle select when we drag a single element 
            //if( DidgeShape.select_rect != null && DidgeShape.drag_index != null){
            //    DidgeShape.select_rect.remove();
            //    DidgeShape.select_rect=null;
            //}

            // rectangle select
            if( DidgeShape.select_rect != null){
                // move rectangle
                x1=DidgeShape.select_rect_startpoint.x;
                x2=e.offsetX;
                y1=DidgeShape.select_rect_startpoint.y;
                y2=e.offsetY;

                DidgeShape.select_rect.segments[1].point=new paper.Point(x1, y1);                
                DidgeShape.select_rect.segments[0].point=new paper.Point(x2, y1);                
                DidgeShape.select_rect.segments[2].point=new paper.Point(x1, y2);         
                DidgeShape.select_rect.segments[3].point=new paper.Point(x2, y2);

                // highlight segments
                if(x2<x1){
                    _=x1;
                    x1=x2;
                    x2=_
                }
                for( var i=0; i<DidgeShape.drag_handles.length; i++){
                    px=DidgeShape.drag_handles[i].segments[0].point.x;
                    if(px>=x1 && px<=x2){
                        DidgeShape.drag_handles[i].strokeColor="black";
                        DidgeShape.drag_handles[i].selected=true;
                    } else{
                        DidgeShape.drag_handles[i].selected=false;
                    }
                }
            }
        });

        $(document).mouseup(function(){
            if( DidgeShape.select_rect != null && DidgeShape.dragMode == DidgeShape.DRAG_MODE_MULTIPLE_SELECTING){
                x1=DidgeShape.select_rect.segments[1].point.x;
                x2=DidgeShape.select_rect.segments[0].point.x;

                DidgeShape.select_rect.remove();
                DidgeShape.select_rect=null;
                DidgeShape.dragMode=DidgeShape.DRAG_MODE_MULTIPLE_SELECTED;
            } else if( DidgeShape.dragMode == DidgeShape.DRAG_MODE_MULTIPLE_DRAGGING){
                DidgeShape.dragMode = DidgeShape.DRAG_MODE_NONE;
                for( var i=0; i<DidgeShape.drag_handles.length; i++){
                    DidgeShape.drag_handles[i].selected=false;
                    DidgeShape.drag_handles[i].strokeColor="#cccccc";
                }
            }
        });

        canvas.addEventListener('mouseup', e => {
            DidgeShape.drag_index=null;
        });
        canvas.addEventListener('dblclick', e => {
        });
        DidgeShape.draw_didge();
    },
}

$(document).ready(function(){
    loadTableWidget();
    DidgeShape.setup();
});
</script>
</head>
<body>
	<canvas id="myCanvas" width="1100" height="200"></canvas>

    <h2>Dimensions</h2>
    <table id="dimensions" class="table table-striped">
        <thead><tr><th>X</th><th>Y</th>
        <tbody>
        </tbody>
      </table>
</body>
</html>